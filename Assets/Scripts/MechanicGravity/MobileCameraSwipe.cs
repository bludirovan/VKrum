using UnityEngine;
using UnityEngine.EventSystems;
using Cinemachine;

[ExecuteAlways]
public class MobileCameraSwipe : MonoBehaviour
{
    [Tooltip("UI?????????, ??????? ??????? ?????????")]
    public Joystick moveJoystick;

    // ????????? ???????????? ???????, ????? ????? ???????????????
    private CinemachineCore.AxisInputDelegate _originalGetAxis;

    void OnEnable()
    {
        _originalGetAxis = CinemachineCore.GetInputAxis;
        CinemachineCore.GetInputAxis = GetAxisOverride;
    }

    void OnDisable()
    {
        CinemachineCore.GetInputAxis = _originalGetAxis;
    }

    float GetAxisOverride(string axisName)
    {
        // 1) ?????????, ???? ???????? ?????
        if (moveJoystick != null &&
            (Mathf.Abs(moveJoystick.Horizontal) > 0.1f ||
             Mathf.Abs(moveJoystick.Vertical) > 0.1f))
        {
            return 0f;
        }

        // 2) ?????????, ???? ??????? ????? ?????????
        int f = JoystickFingerTracker.ActiveFingerId;
        if (f >= 0)
        {
            // ???? ???? ????? ?????? ????? ? ?? ???? ????????
            foreach (var t in Input.touches)
            {
                if (t.fingerId == f)
                    return 0f;
            }
        }

        // 3) ?????????, ???? ???????/???? ??? ????? UI??????????
        // ? ????
        if (Input.GetMouseButton(0) &&
            EventSystem.current.IsPointerOverGameObject())
        {
            return 0f;
        }

        // ? ????
        for (int i = 0; i < Input.touchCount; i++)
        {
            if (EventSystem.current.IsPointerOverGameObject(Input.GetTouch(i).fingerId))
                return 0f;
        }

        // 4) ????? ? ?????? ????????? ???? (????/???/?????)
        return _originalGetAxis(axisName);
    }
}
